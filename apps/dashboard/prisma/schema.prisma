generator client {
  provider        = "prisma-client-js"
  output          = "../lib/generated/prisma"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String         @unique @db.VarChar(255)
  password_hash   String         @db.VarChar(255)
  first_name      String?        @db.VarChar(255)
  last_name       String?        @db.VarChar(255)
  name            String?        @db.VarChar(255)
  phone           String?        @db.VarChar(50)
  role            String         @default("USER") @db.VarChar(50)
  is_active       Boolean?       @default(true)
  is_verified     Boolean?       @default(false)
  created_at      DateTime?      @default(now()) @db.Timestamp(6)
  updated_at      DateTime?      @default(now()) @updatedAt @db.Timestamp(6)
  deleted_at      DateTime?      @db.Timestamp(6)
  organization_id String?        @db.Uuid
  permissions     Json?          @default("{}")
  replies         TicketReply[]
  tickets         Ticket[]
  organization    organizations? @relation(fields: [organization_id], references: [id])

  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

model Ticket {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  subject     String           @db.VarChar(255)
  description String
  status      ticket_status?   @default(OPEN)
  priority    ticket_priority? @default(MEDIUM)
  category    String           @db.VarChar(100)
  user_id     String           @db.Uuid
  created_at  DateTime?        @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?        @default(now()) @updatedAt @db.Timestamptz(6)
  replies     TicketReply[]
  user        User             @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([priority], map: "idx_tickets_priority")
  @@index([status], map: "idx_tickets_status")
  @@index([user_id], map: "idx_tickets_user_id")
  @@map("tickets")
}

model TicketReply {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  message    String
  ticket_id  String    @db.Uuid
  user_id    String    @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  ticket     Ticket    @relation(fields: [ticket_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user       User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([ticket_id], map: "idx_ticket_replies_ticket_id")
  @@index([user_id], map: "idx_ticket_replies_user_id")
  @@map("ticket_replies")
}

model activity_logs {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id         String?        @db.Uuid
  organization_id String?        @db.Uuid
  action          String         @db.VarChar(100)
  entity_type     String         @db.VarChar(100)
  entity_id       String?        @db.Uuid
  details         Json?
  ip_address      String?        @db.VarChar(45)
  user_agent      String?
  status          String?        @default("success") @db.VarChar(20)
  created_at      DateTime?      @default(now()) @db.Timestamptz(6)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([created_at], map: "idx_activity_logs_created")
  @@index([organization_id], map: "idx_activity_logs_organization")
  @@index([user_id], map: "idx_activity_logs_user")
}

model analytics_data {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?        @db.Uuid
  date            DateTime       @db.Date
  metric_name     String         @db.VarChar(100)
  metric_value    Decimal        @db.Decimal(15, 2)
  dimensions      Json?
  created_at      DateTime?      @default(now()) @db.Timestamptz(6)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([organization_id, date, metric_name])
  @@index([organization_id, date], map: "idx_analytics_data_org_date")
}

model api_keys {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?        @db.Uuid
  name            String         @db.VarChar(255)
  key_hash        String         @unique @db.VarChar(255)
  permissions     Json?
  last_used_at    DateTime?      @db.Timestamptz(6)
  expires_at      DateTime?      @db.Timestamptz(6)
  is_active       Boolean?       @default(true)
  created_at      DateTime?      @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?      @default(now()) @db.Timestamptz(6)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model audit_trails {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id     String?   @db.Uuid
  action      String    @db.VarChar(50)
  entity_type String    @db.VarChar(100)
  entity_id   String    @db.Uuid
  old_values  Json?
  new_values  Json?
  ip_address  String?   @db.Inet
  user_agent  String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@index([entity_type, entity_id], map: "idx_audit_trails_entity")
  @@index([user_id], map: "idx_audit_trails_user")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model invoices {
  id              String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  subscription_id String?        @db.Uuid
  organization_id String?        @db.Uuid
  invoice_number  String         @unique @db.VarChar(100)
  amount          Decimal        @db.Decimal(10, 2)
  currency        String?        @default("PKR") @db.VarChar(10)
  status          String         @default("draft") @db.VarChar(20)
  due_date        DateTime?      @db.Timestamptz(6)
  paid_at         DateTime?      @db.Timestamptz(6)
  pdf_url         String?
  created_at      DateTime?      @default(now()) @db.Timestamptz(6)
  organizations   organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  subscriptions   subscriptions? @relation(fields: [subscription_id], references: [id], onUpdate: NoAction)

  @@index([organization_id], map: "idx_invoices_organization")
  @@index([status], map: "idx_invoices_status")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model notification_preferences {
  user_id               String    @id @db.Uuid
  email_notifications   Boolean   @default(true)
  push_notifications    Boolean   @default(true)
  desktop_notifications Boolean   @default(true)
  mute_until            DateTime? @db.Timestamptz(6)
  excluded_types        String[]  @default([]) @db.VarChar(20)
  digest_frequency      String    @default("realtime") @db.VarChar(20)
  role_specific_filters Json?     @default("{}")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model notifications {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String    @db.Uuid
  title        String    @db.VarChar(255)
  message      String
  type         String    @default("info") @db.VarChar(20)
  priority     String    @default("medium") @db.VarChar(20)
  read         Boolean   @default(false)
  metadata     Json?
  expires_at   DateTime? @db.Timestamptz(6)
  action_url   String?   @db.VarChar(500)
  action_label String?   @db.VarChar(100)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @db.Timestamptz(6)

  @@index([created_at(sort: Desc)], map: "idx_notifications_created_at")
  @@index([metadata], map: "idx_notifications_metadata_gin", type: Gin)
  @@index([priority], map: "idx_notifications_priority")
  @@index([type], map: "idx_notifications_type")
  @@index([user_id], map: "idx_notifications_user_id")
  @@index([user_id, priority, created_at(sort: Desc)], map: "idx_notifications_user_priority_created")
  @@index([user_id, read, created_at(sort: Desc)], map: "idx_notifications_user_read_created")
  @@index([user_id, type, created_at(sort: Desc)], map: "idx_notifications_user_type_created")
}

model organizations {
  id             String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name           String           @db.VarChar(255)
  slug           String           @unique @db.VarChar(100)
  plan           String           @default("basic") @db.VarChar(50)
  status         String           @default("active") @db.VarChar(20)
  industry       String?          @db.VarChar(100)
  business_type  String?          @db.VarChar(100)
  employee_count String?          @db.VarChar(50)
  billing_email  String?          @db.VarChar(255)
  phone          String?          @db.VarChar(50)
  address        String?
  country        String?          @db.VarChar(100)
  timezone       String?          @default("Asia/Karachi") @db.VarChar(50)
  currency       String?          @default("PKR") @db.VarChar(10)
  created_at     DateTime?        @default(now()) @db.Timestamptz(6)
  updated_at     DateTime?        @default(now()) @db.Timestamptz(6)
  deleted_at     DateTime?        @db.Timestamptz(6)
  activity_logs  activity_logs[]
  analytics_data analytics_data[]
  api_keys       api_keys[]
  invoices       invoices[]
  subscriptions  subscriptions[]
  transactions   transactions[]
  users          User[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model subscriptions {
  id                   String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id      String?        @db.Uuid
  plan                 String         @db.VarChar(50)
  status               String         @default("active") @db.VarChar(20)
  current_period_start DateTime       @db.Timestamptz(6)
  current_period_end   DateTime       @db.Timestamptz(6)
  cancel_at_period_end Boolean?       @default(false)
  canceled_at          DateTime?      @db.Timestamptz(6)
  trial_start          DateTime?      @db.Timestamptz(6)
  trial_end            DateTime?      @db.Timestamptz(6)
  created_at           DateTime?      @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?      @default(now()) @db.Timestamptz(6)
  invoices             invoices[]
  organizations        organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([organization_id], map: "idx_subscriptions_organization")
  @@index([status], map: "idx_subscriptions_status")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model system_logs {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  component  String    @db.VarChar(100)
  level      String    @db.VarChar(20)
  message    String
  details    Json?
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([created_at], map: "idx_system_logs_created")
}

model transactions {
  id              String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organization_id String?           @db.Uuid
  user_id         String?           @db.Uuid
  amount          Decimal           @db.Decimal(10, 2)
  currency        String?           @default("PKR") @db.VarChar(10)
  status          String            @default("pending") @db.VarChar(20)
  payment_method  String            @db.VarChar(50)
  description     String?
  created_at      DateTime?         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?         @default(now()) @db.Timestamptz(6)
  items           TransactionItem[]
  organizations   organizations?    @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([organization_id], map: "idx_transactions_organization")
  @@index([status], map: "idx_transactions_status")
}

model user_sessions {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  user_id       String?   @db.Uuid
  session_token String    @unique @db.VarChar(255)
  ip_address    String?   @db.Inet
  user_agent    String?
  expires_at    DateTime  @db.Timestamptz(6)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
}

model Category {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String    @db.VarChar(255)
  organization_id String?   @db.Uuid
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @updatedAt @db.Timestamptz(6)
  products        Product[]

  @@map("categories")
}

model Product {
  id                String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String            @db.VarChar(255)
  sku               String?           @unique @db.VarChar(100)
  description       String?
  price             Decimal           @db.Decimal(10, 2)
  cost              Decimal?          @db.Decimal(10, 2)
  stock             Int               @default(0)
  unit              String?           @default("Unit") @db.VarChar(50)
  category_id       String?           @db.Uuid
  organization_id   String?           @db.Uuid
  created_at        DateTime          @default(now()) @db.Timestamptz(6)
  updated_at        DateTime?         @updatedAt @db.Timestamptz(6)
  category          Category?         @relation(fields: [category_id], references: [id])
  transaction_items TransactionItem[]

  @@map("products")
}

model TransactionItem {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  transaction_id String       @db.Uuid
  product_id     String       @db.Uuid
  quantity       Int
  unit_price     Decimal      @db.Decimal(10, 2)
  total_price    Decimal      @db.Decimal(10, 2)
  product        Product      @relation(fields: [product_id], references: [id])
  transaction    transactions @relation(fields: [transaction_id], references: [id], onDelete: Cascade)

  @@map("transaction_items")
}

model system_settings {
  key        String    @id @db.VarChar(100)
  value      Json?
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_by String?   @db.Uuid
}

model onboarding_progress {
  organization_id String    @db.Uuid
  step_id         String    @db.VarChar(100)
  completed       Boolean   @default(false)
  completed_at    DateTime? @db.Timestamptz(6)

  @@unique([organization_id, step_id])
  @@index([organization_id], map: "idx_onboarding_progress_organization")
}

model user_invitations {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String    @db.Uuid
  email           String    @db.VarChar(255)
  role            String    @db.VarChar(50)
  token           String    @unique @db.VarChar(255)
  invited_by      String    @db.Uuid
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  expires_at      DateTime  @db.Timestamptz(6)

  @@index([organization_id], map: "idx_user_invitations_organization")
  @@index([email], map: "idx_user_invitations_email")
  @@index([token], map: "idx_user_invitations_token")
}

model role_permissions {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String         @db.Uuid
  role_name       String         @db.VarChar(50)
  permissions     Json           @default("{}")
  created_at      DateTime?      @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?      @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([organization_id, role_name])
}

enum ticket_priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ticket_status {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}
